{
	# Make sure the WAF middleware is evaluated before any others
	order coraza_waf first
}

:{$PORT} {
	# Mini liveness probe for Railway
	respond /health 200

	# Security headers
	header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
	header Content-Security-Policy  upgrade-insecure-requests

	# OWASP Coraza WAF (Core Rule Set auto-loaded by the plugin build)
	coraza_waf

	# Proxy everything else to your app
	# BACKEND is an env-var like "app:3000"
	reverse_proxy {env.BACKEND} {
		header_up X-Forwarded-Proto  https
		header_up X-Forwarded-Scheme https
		# header_up X-Forwarded-Port 443     # uncomment if your app expects it
		# header_up X-Forwarded-Host {host}  # idem
	}
}
