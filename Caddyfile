{
    order realip first
    order coraza_waf after realip

    # Enhanced logging with more security-relevant fields
    log {
        format json
        output stdout
        include http.request.header.x-real-ip 
                http.request.remote_host 
                http.response.status 
                http.request.uri 
                http.request.method
                http.request.header.user-agent
                http.request.header.x-forwarded-for
                http.request.duration
    }
}

:{$PORT} {
    respond /health 200

    realip {
        header X-Forwarded-For  
        header X-Real-IP
        from   100.64.0.0/10
    }

    @not_websocket {
        not header Connection *upgrade*
        not header Upgrade websocket
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        Content-Security-Policy  upgrade-insecure-requests
        Referrer-Policy          no-referrer
        Permissions-Policy       interest-cohort=()
        X-Content-Type-Options   nosniff
        X-Frame-Options          SAMEORIGIN
        -Server
    }

    coraza_waf @not_websocket {
        load_owasp_crs
        directives `
            Include @coraza.conf-recommended
            Include @crs-setup.conf.example
            Include @owasp_crs/*.conf

            SecAction "id:900000,phase:1,setvar:'tx.paranoia_level=2'"

            SecRuleEngine On
            SecAuditEngine RelevantOnly
            SecAuditLogParts ABIFHZ
            SecAuditLog /dev/stdout
            SecAuditLogFormat json
        `
    }

    reverse_proxy {env.BACKEND} {
        header_up X-Forwarded-Proto  https
        header_up X-Forwarded-Scheme https
    }
}
