{
	# realip stays first (harmless without X-Forwarded-For)
	order realip first
	order coraza_waf after realip

	log {
		format json
		output stdout
	}
}

:{$PORT} {

	# 1) Liveness probe
	respond /health 200

	# 2) Attempt real-IP rewrite (works only if upstream CDN adds the header)
	realip {
		header X-Forwarded-For
		from   100.64.0.0/10   # Railway NAT range
	}

	# 3) Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		Content-Security-Policy  upgrade-insecure-requests
		Referrer-Policy          no-referrer
		Permissions-Policy       interest-cohort=()
		X-Content-Type-Options   nosniff
		X-Frame-Options          SAMEORIGIN
		-Server
	}

	# 4) Coraza WAF + CRS-v4
	coraza_waf {
		load_owasp_crs
		directives `
			Include @coraza.conf-recommended
			Include @crs-setup.conf.example
			Include @owasp_crs/*.conf

			# Paranoia level 2 (silent)
			SecAction "id:900000,phase:1,setvar:'tx.paranoia_level=2'"

			# Blocking mode + slim audit log
			SecRuleEngine On
			SecAuditEngine RelevantOnly
			SecAuditLogParts ABIFHZ
			SecAuditLog /dev/stdout
			SecAuditLogFormat json
		`
	}

	# 5) Upstream service (with real WebSocket support)
	reverse_proxy {env.BACKEND} {
		# 1) Preserve Host so the backend accepts the handshake
		header_up Host {host}

		# 2) WebSocket handshake headers
		header_up Upgrade    {>Upgrade}
		header_up Connection {>Connection}

		# 3) Forward scheme + original host if you need them
		header_up X-Forwarded-Proto  {scheme}
		header_up X-Forwarded-Host   {host}

		# 4) Tell Caddy to speak HTTP/1.1 (WebSockets donâ€™t run over HTTP/2)
		transport http {
			versions 1.1
		}
	}
}
