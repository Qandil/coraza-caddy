{
	# WAF must run first; enable JSON logs to stdout for Railway
	order coraza_waf first
	log {
		format json
		output stdout
	}
}

:{$PORT} {
	respond /health 200

	header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
	header Content-Security-Policy  upgrade-insecure-requests

	# ---------- CORAZA WAF ----------
	coraza_waf {
		# Mount the Core Rule Set that was compiled into the binary
		load_owasp_crs

		# Feed SecLang instructions (back-tick block!)
		directives `
			Include @coraza.conf-recommended
			Include @crs-setup.conf.example
			Include @owasp_crs/*.conf
			SecRuleEngine On
			SecAuditLog /dev/stdout          # put audit events on stdout
			SecAuditLogFormat json
		`
	}

	# Reverse-proxy to your upstream
	reverse_proxy {env.BACKEND} {
		header_up X-Forwarded-Proto  https
		header_up X-Forwarded-Scheme https
	}
}
