{
    order realip first
    order coraza_waf after realip

    log {
        format json
        output stdout
    }
}

:{$PORT} {

    # 1) Liveness probe
    respond /health 200

    # 2) Real-IP rewrite (harmless without XFF on Railway)
    realip {
        header X-Forwarded-For
        from   100.64.0.0/10
    }

    # 3) Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        Content-Security-Policy  upgrade-insecure-requests
        Referrer-Policy          no-referrer
        Permissions-Policy       interest-cohort=()
        X-Content-Type-Options   nosniff
        X-Frame-Options          SAMEORIGIN
        -Server
    }

    # 4) Bypass WAF for WebSockets
    @ws {
        path   /rest/push*
        header Connection *Upgrade*
    }
    reverse_proxy @ws {$BACKEND} {
        transport http {
            versions 1.1
        }
        header_up Host       {host}
        header_up Upgrade    {>Upgrade}
        header_up Connection {>Connection}
        header_up X-Forwarded-Proto {scheme}
    }

    # 5) WAF for everything else
    coraza_waf {
        load_owasp_crs
        directives `
            Include @coraza.conf-recommended
            Include @crs-setup.conf.example
            Include @owasp_crs/*.conf

            # Paranoia level 2
            SecAction "id:900000,phase:1,setvar:'tx.paranoia_level=2'"

            # Blocking + slim audit log
            SecRuleEngine On
            SecAuditEngine RelevantOnly
            SecAuditLogParts ABIFHZ
            SecAuditLog /dev/stdout
            SecAuditLogFormat json
        `
    }

    # 6) Proxy all other HTTP
    reverse_proxy {$BACKEND} {
        header_up Host              {host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Scheme {scheme}
    }
}
