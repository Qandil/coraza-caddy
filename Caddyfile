{
    order realip first
    order coraza_waf after realip
}

:{$PORT} {
    respond /health 200
    encode gzip zstd

    realip {
        header X-Forwarded-For
        header X-Real-IP
        from   100.64.0.0/10
    }

    @not_websocket {
        not header Connection *upgrade*
        not header Upgrade websocket
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        Content-Security-Policy  upgrade-insecure-requests
        Referrer-Policy          no-referrer
        Permissions-Policy       interest-cohort=()
        X-Content-Type-Options   nosniff
        X-Frame-Options          SAMEORIGIN
        -Server
    }

    coraza_waf @not_websocket {
        load_owasp_crs
        directives `
            Include @coraza.conf-recommended
            Include @crs-setup.conf.example
            Include @owasp_crs/*.conf
            SecAction "id:900000,phase:1,setvar:'tx.paranoia_level=2'"
            SecRuleEngine On
            SecAuditEngine RelevantOnly
            SecAuditLogParts ABIFHZ
            SecAuditLog /dev/stdout
            SecAuditLogFormat json
        `
    }

    reverse_proxy {env.BACKEND} {
        header_up X-Forwarded-Proto  https
        header_up X-Forwarded-Scheme https
    }

    log {
        output stdout

        format filter {
            # pull nested fields up to top-level keys
            request>remote_ip           rename remote_ip
            request>client_ip           rename client_ip
            request>method              rename method
            request>uri                 rename message
            response>status             rename status
            response>duration           rename duration
            request>headers>User-Agent  rename user_agent
            request>headers>Referer     rename referer

            # finally, wrap everything as JSON
            wrap json {
                time_key    timestamp
                level_key   severity
            }
        }
    }
}
