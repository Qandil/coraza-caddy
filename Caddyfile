{
	# Make sure WAF runs first
	order coraza_waf first
	# Turn on JSON logging to stdout so Railway captures it
	log {
		format json
		output stdout
	}
}

:{$PORT} {
	respond /health 200

	header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
	header Content-Security-Policy  upgrade-insecure-requests

	# === WAF proper ===
	coraza_waf {
		# 1. Load the OWASP Core Rule Set that was embedded at build time
		include @owasp_crs                # <— critical line
		# 2. Make sure we’re in blocking mode
		directive SecRuleEngine On
		# 3. Emit audit logs to stdout (Railway → “Logs” tab)
		auditlog stdout
	}

	# Proxy everything else to your backend
	reverse_proxy {env.BACKEND} {
		header_up X-Forwarded-Proto  https
		header_up X-Forwarded-Scheme https
	}
}
