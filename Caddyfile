{
    order realip first
    order coraza_waf after realip
}

:{$PORT} {
    respond /health 200

    encode gzip zstd

    realip {
        header X-Forwarded-For  
        header X-Real-IP
        from   100.64.0.0/10
    }

    @not_websocket {
        not header Connection *upgrade*
        not header Upgrade websocket
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        Content-Security-Policy  upgrade-insecure-requests
        Referrer-Policy          no-referrer
        Permissions-Policy       interest-cohort=()
        X-Content-Type-Options   nosniff
        X-Frame-Options          SAMEORIGIN
        -Server
    }

    coraza_waf @not_websocket {
        load_owasp_crs
        directives `
            Include @coraza.conf-recommended
            Include @crs-setup.conf.example
            Include @owasp_crs/*.conf

            SecAction "id:900000,phase:1,setvar:'tx.paranoia_level=2'"

            SecRuleEngine On
            SecAuditEngine RelevantOnly
            SecAuditLogParts ABIFHZ
            SecAuditLog /dev/stdout
            SecAuditLogFormat json
        `
    }

    reverse_proxy {env.BACKEND} {
        header_up X-Forwarded-Proto  https
        header_up X-Forwarded-Scheme https
    }

    # ——— ACCESS LOGGING ———
    log {
        output stdout

        format filter {
            wrap json {
                time_key    timestamp
                level_key   severity
                message_key message
            }
            fields {
                request>remote_ip
                request>client_ip
                request>method
                request>uri       rename message
                response>status
                response>duration
                request>headers>User-Agent
                request>headers>Referer
            }
        }
    }
}
