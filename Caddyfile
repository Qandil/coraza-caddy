{
    order realip first
    order coraza_waf after realip
    log {
        format json
        output stdout
    }
}

:{$PORT} {
    # 1) Health check
    respond /health 200

    # 2) Real-IP (harmless unless you front with a CDN)
    realip {
        header X-Forwarded-For
        from   100.64.0.0/10
    }

    # 3) Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        Content-Security-Policy  upgrade-insecure-requests
        Referrer-Policy          no-referrer
        Permissions-Policy       interest-cohort=()
        X-Content-Type-Options   nosniff
        X-Frame-Options          SAMEORIGIN
        -Server
    }

    # ─── 4) WS ROUTE (bypass WAF) ────────────────────────────────────────────
    @ws {
        path   /rest/push*
        header Connection Upgrade
    }
    route @ws {
        reverse_proxy {$BACKEND} {
            transport http {
                versions 1.1
            }
            flush_interval -1
            header_up Host              {host}
            header_up Upgrade           {>Upgrade}
            header_up Connection        {>Connection}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # ─── 5) EVERYTHING ELSE ─────────────────────────────────────────────────
    route {
        # WAF
        coraza_waf {
            load_owasp_crs
            directives `
                Include @coraza.conf-recommended
                Include @crs-setup.conf.example
                Include @owasp_crs/*.conf

                # Paranoia 2
                SecAction "id:900000,phase:1,setvar:'tx.paranoia_level=2'"

                SecRuleEngine On
                SecAuditEngine RelevantOnly
                SecAuditLogParts ABIFHZ
                SecAuditLog /dev/stdout
                SecAuditLogFormat json
            `
        }

        # HTTP proxy
        reverse_proxy {$BACKEND} {
            header_up Host              {host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Scheme {scheme}
        }
    }
}
